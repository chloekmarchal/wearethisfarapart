<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>we're this far apart</title>

    <!-- p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

    <style>
      body {
        margin: 0;
        background: #ffffff;
        color: rgb(0, 0, 0);
        font-family: Arial, Helvetica, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      canvas {
        margin-top: 20px;
      }

      h1 {
        font-size: 3em;
      }
    
    </style>
  </head>
  <body>
    <h1>if 1px = 30.6km</h1>
    <p>(it is more fun with a friend)</p>


    <script>
      let video;
      let hands;
      let camera;
      let results = null;

      const cities = [
        { name: "Toronto", distance: 510 },
        { name: "Mississauga", distance: 563 },
        { name: "Scarborough", distance: 517 },
        { name: "Rancho Palos Verdes, CA", distance: 4639 },
        { name: "Long Beach, CA", distance: 4614 },
        { name: "Los Angeles", distance: 4593 },
        { name: "Valence", distance: 5900 },
        { name: "Strasbourg", distance: 5887 },
        { name: "Paris", distance: 5500 },
        { name: "Shanghai", distance: 11340 },
        { name: "Hong Kong", distance: 12460 },
        { name: "Saigon", distance: 13770 },
      ];

      // 1px = 30.6 km
      function kmToPixels(km) {
        const ratio = 30.6;
        let px = km / ratio;
        return min(px, 450);
      }

      function setup() {
        createCanvas(640, 480);
        video = createCapture(VIDEO);
        video.size(width, height);
        video.hide();

        hands = new Hands({
          locateFile: (file) =>
            `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
        });

        hands.setOptions({
          maxNumHands: 2,
          modelComplexity: 1,
          minDetectionConfidence: 0.7,
          minTrackingConfidence: 0.7,
        });

        hands.onResults((res) => {
          results = res;
        });

        camera = new Camera(video.elt, {
          onFrame: async () => {
            if (video.elt.readyState >= 2) {
              await hands.send({ image: video.elt });
            }
          },
          width: width,
          height: height,
        });
        camera.start();
      }

      function draw() {
        background(0);

        // Mirror video
        push();
        translate(width, 0);
        scale(-1, 1);
        image(video, 0, 0, width, height);
        pop();

        if (results && results.multiHandLandmarks) {
          drawHands(results.multiHandLandmarks);
        } else {
          fill(255);
          noStroke();
          textSize(24);
          text("plz put ur hands up ;P", 20, 40);
        }
      }

      function drawHands(multiHandLandmarks) {
        let indexTips = [];

        for (let i = 0; i < multiHandLandmarks.length; i++) {
          const landmarks = multiHandLandmarks[i];

          // Index fingertip
          const tip = landmarks[8];
          const tipX = width - tip.x * width;
          const tipY = tip.y * height;
          fill(255); // White circles
          noStroke();
          circle(tipX, tipY, 15);
          indexTips.push({ x: tipX, y: tipY });
        }

        if (indexTips.length === 2) {
          const a = indexTips[0];
          const b = indexTips[1];

          // Draw line between fingertips in white
          stroke(255);
          strokeWeight(1);
          line(a.x, a.y, b.x, b.y);

          // Pixel distance
          const pxDist = dist(a.x, a.y, b.x, b.y);

          // Convert pixel distance to km
          const kmDist = pxDist * 30.6;

          // Find nearest city
          let nearestCity = cities.reduce((prev, curr) => {
            return Math.abs(curr.distance - kmDist) <
              Math.abs(prev.distance - kmDist)
              ? curr
              : prev;
          });

          // Draw rotated text along the line (km distance) in white
          const midX = (a.x + b.x) / 2;
          const midY = (a.y + b.y) / 2;
          const angle = atan2(b.y - a.y, b.x - a.x);

          push();
          translate(midX, midY);
          rotate(angle);
          textAlign(CENTER, BOTTOM);
          fill(255);
          textSize(20);
          text(
            `${nearestCity.name} â†’ ${Math.round(kmDist).toLocaleString()} km`,
            0,
            -10
          );
          pop();
        }
      }
    </script>
  </body>
</html>
